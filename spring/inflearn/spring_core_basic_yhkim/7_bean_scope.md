# 빈 스코프

### 스프링은 다양한 스코프를 지원한다.
 * 싱글톤 : 기본 스코프로, 스프링 컨테이너의 시작과 종료까지 유지되는 가장 넓은 범위의 스코프
 * 프로토타입 : 스프링 컨테이너가 빈의 생성과 의존주입까지만 관여하고, 더는 관리하지 않는 매우 짧은 범위의 스코프
 * 웹 관련 스코프
    * `request` : 웹 요청이 들어오고 나갈때까지 유지
    * `session` : 웹 세션이 생성되고 종료될때까지 유지
    * `application` : 웹의 서블릿 컨텍스트와 같은 범위 

### 스코프 지정 : @Scope 애노테이션
``` java
@Scope("prototype")
@Component
public class HelloBean {}
```

``` java
@Scope("prototype")
@Bean
PrototypeBean HelloBean {
  return new HelloBean();
}
```

## 1. 프로토타입 스코프
 * 싱글톤 스코프는 빈을 조회하면 스프링 컨테이너는 항상 같은 인스턴스를 반환한다.
 * 하지만, 프로토타입 스코프는 스프링 컨테이너에 조회하면 항상 새로운 인스턴스를 생성(의존관계 주입, 초기화까ㅣ만)해서 반환한다.
    * 클라이언트에세 프로토타입 스코프를 반환하고 나면, 스프링 컨테이너는 이후 해당 빈을  관리하지 않는다. 
    * 관리 책임은 프로토타입 빈을 호출한 클라이언트에 있다. 따라서 빈에 설정된 소멸 메서드는 자동으로 호출되지 않는다.


## 2. 프로토타입 스코프 - 싱글톤 빈과 함께 사용시 문제점
 * 싱글톤 빈 내부에 프로토타입 빈을 의존관계로 가지고 있을 때, 싱글톤 빈 생성 시점에 프로토타입도 함께 생성되어 계속 참조되어 사용된다.
    * 즉 프로토타입 빈은 제 역할을 제대로 하지 못하게 된다.

## 3. 프로토타입 스코프 - 싱글톤 빈과 함께 사용시 Provider로 문제 해결
 * 의존관계를 외부에서 주입 받는게 아니라, 직접 필요한 의존관계를 찾는 것을 Dependency Lookup (DL) 의존관계 조회 라고 한다.
 * 그러나 이렇게 스프링 컨텍스트 전체를 주입받게 되면, 스프링 컨테이너 종속적인 코드가 되고 단위 테스트도 어려워진다.
 * 그래서 이러한 기능을 편하게 제공하는 스프링 기능이 있다. ObjectFacory, ObjectProvider
 * ObjectProvider : 지정한 빈을 컨테이너 대신 찾아주는 서비스 (ObjectFacory 에 편의기능을 몇가지 더한 것)
 * 위 기능을 사용하면, 싱글톤 빈과 함께 사용하더라도 프로토타입 빈을 역할대로 사용할 수 있다.

```java
@Autowired
ObjectProvider<PrototypeCustomBean> provider;

PrototypeCustomBean prototypeCustomBean = provider.getObject();
```

#### `javax.inject.Provdier` ObjectProvider 와 비슷한 용도로 사용 가능.
 * get() 메서드 하나로 기능이 매우 단순
 * 라이브러리 추가 필요
 * 자바 표준이므로 스프링 외의 다른 컨테이너에서 사용 가능.

## 4. 웹 스코프
 * 프로토타입과는 다르게, 스프링이 종료시점까지 관리해준다. (종료 메서드를 호출해준다.)
 * HTTP 요청당 하나씩 생성되고, 요청이 끝나면 소멸된다.
 * 종류 : request, session, application, webSocket
    * 사용방법 : 빈 클래스 위에 `@Scope(value = "request")`
 * `spring-boot-starter-web` 라이브러리 추가 필요 -> 스프링부트는 내장 톰캣 서버를 활용하여 웹서버와 스프링을 함께 실행시킨다.
 * 단점은 웹 요청이 들어올때 빈이 생성되기 때문에 Spring 톰캣 시작 시점이 빈이 없다고 에러를 발생시킨다. 따라서 이 부분을 해결해야 한다.
    * 이 부분을 해결하는 것이 프록시 설정이다.  `@Scope(value = "request", proxy = ScopedProxyMode.TARGET_CLASS)`
    * Spring 톰캣 실행시점에 빈 대신 프록시 가짜 객체를 대신 빈에 등록해준다.
       * 의존관계 주입에도 가짜 프록시 객체가 주입된다.
       * 이 가짜 프록시 객체는 실제 웹 요청이 오면, 그때 내부에서 진짜 빈을 위임한다.


