# 3. 네트워크와 통신하기

## 3.1 네트워크 통신방식
#### 유니캐스트
 * 1:1 통신
#### 브로드캐스트
* 1:N 통신
* 동일 네트워크 모든 호스트가 목적지
* 유니캐스트 통신하기전에 호스트 위치를 알기위해 사용
#### 멀티캐스트
* 1:N 통신 but 다수의 `특정` 목적지
#### 애니캐스트
* 1:1 통신
* 다수의 목적지 중 가장 가깝건 하요류적인 호스트와 통신
* DNS 서버나 게이트웨이 찾을때 사용


## 3.2 MAC 주소
 * Media Access Control
 * 2계층(데이터 링크)에서 통신을 위해 네트워크 인터페이스에 할당된 고유 식별자

### 3.2.1 주소 체계
 * 하드웨어에 고정되어 있고, 제조사 번호와 제조사별 코드로 구성되어 있음.
 * MAC 주소는 유일하지 않을 수도 있다?
    * 제조사에서 실수나 의도적으로 중복되게 만들 수도 있는데,
    * 동일 네트워크에서만 중복되지 않으면 상관없다.
    * 라우터의 도움을 받을때 출발지와 도착지 MAC 주소가 변경되므로

### 3.2.2 동작
 * NIC는 전기 신호가 들어오면 2계층에서 데이터 형태(패킷)로 변환 → 내용 구분 후 도착지 MAC 주소 확인 → 다르면 폐기 / 자신이거나 그룹 주소이면 상위 계층으로 넘김
 * 특정 네트워크 상태를 모니터링 하거나 분석 용도로 수집해야할 경우에는 `무차별 모드`로 NIC로 구성할 수 도 있다.
    * 자신의 mac 주소와 상관없는 패킷이 들어와도 메모리에 올릴 수 있음. 와이어샤크가 대표적인 애플리케이션 


## 3.3 IP 주소
 * 3계층 주소
 * 사용자가 변경 가능한 논리 주소
 * 네트워크 주소와 호스트 주소(네트워크 내 호스트를 구분) 2가지로 구성

### 3.3.1 주소 구분
#### 클래스풀 네트워크 분할 기법
 * (현재는 이 기법으로 분할해서 사용되진 않음.)
    * 현재는 1비트씩 상세히 분할
 * 맨 앞 속텟의 주소만으로 구분하는 기법
 * 맨 앞 옥텟이
    * 0~127 : A 클래스
    * 128~191 : B 클래스
    * 192~223 : C 클래스

### 3.2.2 클래스리스
 * IP 주소 부족과 낭비 문제를 해결해야 한다.
    * 단기대책 : 클래스리스 CIDR (Classless Inter-Domain Routing)
    * 중기대책 : NAT, 사설 IP
    * 장기대책 : IPv6
 * 1비트 단위 상세하게 쪼개고, 서브넷마스크를 이용해서 네트워크 주소를 구분하자.

### 3.3.3 서브네팅
 * 워래 부여된 클래스의 기준을 무시하고, 원래보다 더 쪼개 사용하는 것.
 * 부여된 주소를 다시 잘라 사용함.
#### 네트워크 유효 범위
 * ip 주소를 2진수로 표현하고 서브넷 마스크와 AND연상을 통해 네트워크 주소를 알아낸다.
 * 호스트 주소 부분을 1로 모두 변경해 브로드캐스트 주소를 알아낸다.
 * 유효범위 : `서브네팅된 네트워크주소 + 1` ~ `브로드캐스트 주소 - 1`

### 3.3.4 공인 IP와 사설 IP
 * 공인IP : 전세계 유일, 통신사업자나 IP할당 기관에서 할당받아야 함
 * 사설IP : 인터넷에 접속하지 않거나 NAT기술을 사용할 경우 사용 가능


## 3.4 TCP, UDP
 * 4계층 프로토콜
 * 2~3계층은 목적지 찾기가 목적이었다면, 여기서부턴 다름
    * 여러 어플리케이션 중 통신할 목적지 프로세스를 찾고
    * 패킷 순서가 바뀌지 않도록 잘 조합해 원래 데이터로 다시 잘 조합하는 역할을 함

### 3.4.1 4계층 프로토콜(TCP, UDP)과 서비스 포트
 * 패킷을 분할하고 조합하기 위해서 TCP 프로토콜에서는 시퀀스 번호와 ACK 번호를 사용
 * 상위 프로토콜 지시자 정보
    * 디캡슐레이션 과정에서 상위 계층의 프로토콜/프로세스를 정확히 찾아가기 위한 목적
    * 2계층: 이더타입, 3계층 프로토콜 번호, 4계층 포트번호

### 3.4.2 TCP
 * 신뢰할 수 없는 공용망에서도 정보유실 없는 통신 보장 → 세션 연결, 데이터 분할, 패킷 전송 확인
 * 패킷에 번호 부여하고 잘 전송되었는지 확인하는 번호 응답 Acknowledge Number
 * 한번에 얼마나 보내야 수신자가 잘 받아 처리할 수 있는지 전송 크기 고려 Window Size

#### 3.4.2.1 패킷 순서, 응답 번호
 * 시퀀스 번호 : 패킷에 순서를 부여함 ACK를 받았다면, 다음 통신엔 받았던 ACK를 SEQ로 한다.
 * ACK 번호 : 응답 번호를 부여함. 보통 SEQ 번호를 잘 받았다는 의미로 SEQ번호 + {Data Size}을 응답하는데 Data Size가 0 이면 +1 한다.
 * 예시
출발지 -> 도착지 : SEQ=10 -> 0번 패킷 보낸다~
도착지 -> 출발지 : SEQ=0, ACK=1 ->  0번 패킷받았음, 이제 1번 보내줘~
출발지 -> 도착지 : SEQ=1, ACK=1 -> 1번 보낸다~
도착지 -> 출발지 : SEQ=1, ACK=563 -> 1번 받음, 563 보내줘~
출발지 -> 도착지 : SEQ=563, ACK=563 -> 563 보낸다~

#### 3.4.2.2 윈도 사이즈와 슬라이딩 윈도
 * 가능한 최대한 많은 패킷을 한꺼번에 보내는 것이 좋다

 * 윈도 사이즈 : 한 번에 받을 수 있는 데이터 크기
 * 슬라이딩 윈도 : 네트워크 상황에 따라 조절하는 것
 * TCP 헤더에서 최대 윈도 사이즈는 2^16 = 64K
   * 현대 네트워크에서는 너무 작음 -> 뒤의 숫자를 무시하는 (?) 방법으로 사이즈를 늘려 통신 증가

 * 데이터 유실 발생시 절반으로 줄이고 정상적인 통신 시 하나씩 늘린다
 * 네트워크 경합 발생 시 작아진 윈도 사이즈로 데이터 통신 속도가 느려져 회선을 제대로 사용하지 못할 수 있음 → 버퍼가 큰 네트워크 장비 / TCP 최적화 솔루션

#### 3.4.2.3 3방향 핸드셰이크
 * TCP 에선 유실없는 통신을 위해 통신 시작전, 사전 연결 작업을 진행, 이를 3방향 핸드셰이크라고 부른다.
 * 서버에서는 클라이언트와 연결을 대기하기 위해 `LISTEN` 상태로 대기
 * 클라이언트 -> 서버 : `SYN` 패킷을 보내면서 자신의 상태를 `SYN-SENT` 상태로 변경한다.
 * 이를 받으면, 서버는 `SYN-RECEIVED` 상태로 변경하고, 클라이언트에 `SYN`,`ACK`를 보낸다.
 * 이를 받으면,클라이언트는 `ESTABLISHED` 상태로 변경 후 다시 서버로 `ACK`를 보낸다.
 * 이를 받으면, 서버는 `ESTABLISHED` 상태로 변경하면서 연결이 완료된다.

### 3.4.3 UDP
 * 4계층의 특징이 거의 없음
    * 3방향 핸드셰이크 없음
    * 데이터 전송을 보장하지 않음
 * 첫 데이터는 리소스 확보를 위해 인터럽트를 거는 용도로 사용되고 유실
 * TCP로 연결확립 후 데이터만 UDP로 전달하기도 함


## 3.5 ARP (Address Resolution Protocol)
 * 상대방의 MAC 주소를 알아내기 위해 사용된느 프로토콜

### 3.5.1 ARP란?
 * IP주소와 MAC 주소 연계해주는 매커니즘
 * TCP-이더넷 프로토콜과 같이 2,3계층 주소사이에 관계가 없을 때 사용

#### 과정
 1. 처음 통신 시도시 ARP 브로드캐스트를 통해 네트워크 전체에 상대방의 MAC 주소를 질의해야 함
 2. ARP 브로드캐스트를 받은 목적지는 ARP 프로토콜을 이용해 자신의 MAC 주소 응답
 3. 1~2 과정을 통해 서로 상대방에 대한 MAC 주소를 학습하고,인캡슐레이션되어 전달
 4. 위 정보를 메모리에 저장해두고 재사용, 논리 주소는 변경 가능하므로 일정시간 통신이 없으면 테이블 삭제

 * 네트워크 장비에서 ARP는 CPU에서 직접 수행 → 짧은 시간 많은 ARP 요청이 오면 부하로 작용
    * 그래서 많은 요청이 들어오면, 필터링하거나 천천히 처리

### 3.5.2 ARP 동작
ARP 패킷 요소 : 송신자 하드웨어 MAC 주소, 송신자 IP 프로토콜 주소, 대상자 MAC 주소, 대상자 IP 프로토콜 주소

#### 서버A → 서버B 로 ping 보낼 때

1. ARP 요청
    * 출발지 MAC, 도착지 MAC, 전송자 MAC, 전송자 IP, 대상자 MAC, 대상자 IP
    * 송신자 / 대상자 와 같이 다른 용어 사용해 일반 패킷과 구분
2. 서버A → 서버B ARP 요청을 네트워크에 브로드캐스트
    * 도착지를 브로드캐스트 FF-FF-FF-FF-FF-FF로 채움
    * 대상자 MAC 주소는 00-00-00-00-00-00으로 채움
3. 모든 단말에 보내지고, 해당하는 단말이 ARP 처리 후 응답을 보냄
    * 이때 송신자 ↔ 대상자
    * 모든 필드를 채워 보냄
    * 유니캐스트
4. 서버A는 ARP 응답을 받아 자신의 캐시 테이블을 채움


### 3.5.3 GARP (Gratuitous ARP)
대상자 IP에 자신을 채워, 로컬 네트워크에 자신을 알릴 목적으로 사용
자신을 알리는 3가지 이유
 * IP 주소 충돌 감지
 * 상대방 ARP 테이블 갱신
 * HA 용도의 클러스터링, VRRP, HSRP

### 3.5.4 RARP (Reverse ARP)
 * 반대로 동작하는 ARP
 * IP주소가 정해져 있지 않은 단말이 IP 할당을 요청할 때 사용

## 3.6 서브넷과 게이트웨이
 * 게이트웨이 : 현재 내가 속한 네트워크 밖으로 통신할때 필요. 
 * 3계층 장비(라우터, 스위치)가 게이트웨이 역할을 할 수 있다.
