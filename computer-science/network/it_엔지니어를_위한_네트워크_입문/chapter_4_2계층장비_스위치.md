# 4. 2계층 장비, 스위치

### 2계층 장비
 * MAC 주소 기반으로 동작
 * 네트워크 중간에서 패킷을 받아 필요한 곳에만 전달

### 참고 : 각 계층의 PDU
 * 1계층 : Bits
 * 2계층 : Frame
 * 3계층 : Packet
 * 4계층 : Segment
 * 애플리케이션 계층 : Data
 * But, 일반적으로 데이터를 쪼개 전달하는 데이터 전체를 패킷이라고 총칭함

## 4.1 스위치 장비 동작
 * 패킷을 동시에 여러 장비가 서로 간섭 없이 통신하도록 도와주는 장비
 * 핵심역할 : 누가 어느 위치에 있는지 파악하고 실제 통신이 시작되면 자신이 알고 있는 위치로 패킷을 정확히 전송하는 것
    * 스위치 내부에 MAC 주소 테이블을 갖고 있기 때문에 가능.
    * 테이블에 목적지 주소가 있다면? 해당 주소로 발송
    * 테이블에 목적지 주소가 없다면? 전체 포트로 패킷 전송
 * 스위치 3가지 동작 방식 : 플러딩 / 어드레스 러닝 / 포워딩&필터링

### 4.1.1 플러딩
 * 허브와 같이 모든 포트로 패킷을 흘리는 동작
 * MAC 주소 테이블에 목적지 주소가 없을때 이 동작을 수행함.
 * 스위치는 LAN에서 동작하므로 자신이 정보를 갖고 있지 않아도 어딘가에 장비가 있을 수 있다고 가정하고 이렇게 동작
#### 관련 보안 공격
 * 비정상적인 플러딩 : 스위치에 엉뚱한 MAC 주소를 습득시키거나 MAC 테이블을 꽉 차게 해 스위치의 플러딩 동작을 유도하는 보안 공격 가능
    * 스위치가 정상적으로 동작하지 않거나 주변에서 공격이 수행되는 상황
 * ARP 포이즈닝(Poisoning) : 모니터링해야 할 IP의 MAC 주소가 공격자 자신인 것처럼 속여 원하는 통신을 받는 방법

### 4.1.2 어드레스 러닝
 * MAC 주소 테이블을 만들고 유지하는 과정
 * 패킷의 출발지 MAC 주소 정보를 이용함
    * 브로드캐스트나 멀티캐스트에 대한 MAC 주소는 학습할 수 없다. (둘다 목적지 MAC 주소 필드에서만 사용)

### 4.1.3 포워딩 & 필터링
 * MAC 주소 테이블에 목적지 주소가 있다면 그 포트로 전송 : 포워딩
 * 목적지와 맞지 않는 포트는 모두 보내지 않음 : 필터링

## 4.2 VLAN
 * Virtual Local Area Network
 * 하나의 물리 스위치에서 여러 개의 네트워크를 나누어 사용할 수 있는 기술

### 4.2.1 VLAN 이란?
 * 물리적 배치와 상관없이 LAN을 논리적을 분할, 구성하는 기술
 * VLAN 간의 통신이 필요하다면, 3계층 장비가 필요함.

### 4.2.2 VLAN 종류와 특징
 * 할당 방식에 따라 `포트 기반`과 `MAC 주소 기반`이 있다.
    * 포트 기반은 자리마다 동일한 네트워크
    * MAC 주소 기반은 단말마다 동일한 네트워크

## 4.3 STP
 * IT 환경에서는 SPoF (Single Point of Failure : 단일 장애점)로 인한 장애를 막기 위해 다양한 노력.
 * 네트워크에서도 하나의 장비의 고장으로 시스템 전체 마비되지 않도록 다중화 노력

### 4.3.1 루프
 * 네트워크 루프 : 마치 연결된 모양의 고리처럼 발송한 패킷이 되돌아오는 형태로 구성된 상황
 * 루프 발생시, 네트워크가 마비되고 통신 불가
 * 원인 : `브로드캐스트 스톰`과 `스위치 MAC 러닝 중복 문제`
 * 해결 : `수동으로 포트 셧다운` 혹은 `STP 적용`

### 4.3.2 STP란?
 * Spanning Tree Protocol
 * 루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 매커니즘.
 * 스위치는 BPDU (Bridge Protocol Data Unit) 라는 프로토콜을 통해 스위치간에 정보를 전달하고, 이렇게 수집된 정보를 이용해 전체 네트워크 트리를 만들어 루프 구간을 확인함.
    * 루프 구간이 확인되면, 루프 지점 (포트) 데이터 트래픽이 통과하지 못하도록 차단.

#### 4.3.2.1 스위치 포트의 상태 및 변경 과정
 * STP가 동작 중인 스위치에서는 루프를 막기 위해, 신규 스위치가 포트에 연결되면 일단 그 포트는 차단 상태로 시작
 * 그 후 BPDU를 기다려 학습하여 구조를 파악한 후 루프라면 차단을 유지하고 아니면 차단을 푼다.

### 4.3.3 향상된 STP
 * STP를 확인하기 위해서는 블로킹 포트가 포워딩 상태로 변경까지 30~50초가 걸린다. 
 * 또한 스위치에 여러 VLAN 이 있으면 각 VLAN별로 STP를 계산해야 하므로 추가 부하 발생

#### 4.3.3.1 RSTP (Rapid STP)
 * 더 빠르게 개선

#### 4.3.3.2 MST (Multiple Spanning Tree)
 * 여러개의 VLAN을 그룹으로 묶고 그 그룹마다 별도의 스패닝 트리가 동작