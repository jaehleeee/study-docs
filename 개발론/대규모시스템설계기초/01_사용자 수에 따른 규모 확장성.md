# 1장. 사용자 수에 따른 규모 확장성
 * 한명의 사용자를 지원하는 시스템 -> 몇백만 사용자를 지원하는 시스템을 설계해보자
 * 시스템의 규모를 확장하는 것은 지속적이고 반복적인 과정이다.

## 1. 단일서버 : 웹서버 1개로 구성
### 사용자 요청 처리 흐름
 * api.mysite.com으로 접속하면
 * DNS에 질의하여 ip 주소로 변환한다. (DNS는 보통 third party 유료 서비스를 이용한다)
 * ip주소는 웹서버의 주소이며 이 주소로 HTTP 요청이 전달된다
 * HTTP 요청을 웹서버가 전달받으면 html 페이지나 json 형태의 응답을 반환한다.

### DB
 * 사용자가 늘고 데이터 영속성이 서비스에 필요하게 되면,
 * 웹 트래픽을 처리하는 웹 계층과 데이터를 관리하는 데이터 계층으로 layer를 나눠야한다.
 * DB는 사용 용도에 따라 RDB, NoSQL 중 한가지를 사용한다.
#### NoSQL 사용이 바람직한 경우
 * 낮은 응답 지연
 * 다루는 데이터가 비정형 (관계형 데이터가 아님)
 * 데이터를 직렬/역직렬화 할 수 있기만 하면 된다.
 * 아주 많은 양의 데이터를 저장할 필요가 있음.

## 2. 자동복구(failover) 대응
### 수직 규모 확장 vs 수평 규모 확장
 * 수직 규모 확장 (스케일업) : 서버 사양 증가시키는 방식 / 비쌈, 확장에 한계가 있음, 자동복구 불가
 * 수평 규모 확장 (스케일아웃) : 서버 개수 증가시키는 방식

### 로드밸런서
 * 1개 웹서버는 웹서버가 다운되거나 1개 가용량이 한정적이므로 스케일 아웃해줄 필요가 있다.
 * 스케일아웃한 여러 웹서버에 트래픽을 고르게 분산시키는 역할을 하는 것이 로드밸런서
 * 공개 ip를 로드밸런서로 설정하고, 로드밸런서로 요청이 들어오면 연결된 웹서버들 중 하나로 요청을 전달한다.
    * 이때 사설 ip를 활용하여, 같은 네트워크에 속한 서버 사이의 통신만 되도록 한다.
  
### DB 다중화
 * DB 서버 사이에 master-slave 관계를 설정하고, 데이터 원본은 master, slave 는 이를 복제해와서 읽기전용으로 사용한다.

### 사용자 요청 처리 흐름 (2)
 * 클라이언트는 www.mysite.com을 주소창에 호출한다
 * DNS를 통해 로드밸런서 공개ip를 받는다
 * 클라이언트는 공개ip로 요청을 보내면, 로드밸런서가 이를 등록된 사설ip 연결된 웹서버 한 곳으로 전달한다.
 * 웹서버는 slave DB에서 데이터를 읽는다. (데이터 변경 연산은 master DB)
 * 읽은 데이터를 클라이언트에게 응답한다.

![image](https://github.com/jaehleeee/study-docs/assets/48814463/d195b601-58a3-41a0-8d8d-dbb0908d4f97)


## 3. 성능 개선
### 캐시
 * 캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤 이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소다.
#### 캐시 설정시 유의사항
 * 캐시 사용이 적절한가
 * 어떤 데이터를 캐시하는가
 * 보관 만료는?
 * 일관성은 어떻게 유지되는가
 * 장애 대처는?
 * 캐시 메모리 사이즈는?
 * 캐시 꽉차서 데이터 방출 정책은?

## 4. 글로벌 운영
### CDN
 * 정적 컨첸츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크
 * 주로 third-party 에 의해 운영

### 데이터센터
 * 하나의 데이터 센터 장애를 대비하기 위해 2개의 데이터 센터를 운영할 수 있다
 * 장애가 없는 상황에서는 클라이언트와 가까운 데이터 센터로 안내된다. (이를 geoDNS-routing 또는 geo-routing 이라고 부른다)
 * 한 곳의 데이터 센터 장애시, 장애가 없는 데이터센터로 요청들이 전송된다.
#### 고려사항
 * 트래픽 우회 - 가장 가까운 데이터센터로 트래픽을 보내야한다.
 * 데이터 동기화 - 데이터 센터별로 별도의 DB를 사용한다면, 여러 데이터센터간 데이터 다중화 전략이 필요하다
 * 자동화 배포도구를 통해 여러 데이터센터에 동일한 서비스가 설치되도록 해야 한다.

## 5. 기타
 * 메시지 큐, 로그, 메트릭 그리고 자동화
### 데이터베이스 규모 확장
 * 스케일 업 : 한대의 DB 성능을 올리는 방식, 스택오버플로가이렇게 처리했다고함
 * 스케일 아웃 : 샤딩이라고 부른다. 샤드라고 하는 작은 단위로 분할. 모든 샤드는 같은 스키마를 쓰지만 보관 데이터 사이에 중복이 없다. 
### 샤딩 전략 구현시 고려사항
 * 샤딩 키 (파티션 키) 설정시, 데이터가 고르게 분할되도록 할 수 있어야 한다.
 * 재샤딩 : 데이터가 너무 많아져서 하나의 샤드로 감장이 어렵거나 데이터 분포가 균등하지 못한 경우 (5장 안정 해시 기법에서 이를 해결)
 * celebrity 문제 : 특정 샤드로 질의가 집중되어 서버 과부하 걸리는 문제. 유명인사를 분산시킬 필요가 있다
 * 조인과 비정규화 : 하나의 DB를 여러 샤드로 나누고 나면 여러 샤드 데이터 조인이 힘드니, 비정규화하여 하나의 테이블에서 질의가 수행될 수 있도록 하자.
