# 11장 뉴스 피드 시스템 설꼐
뉴스피드란? 홈페이지 중앙에 지속적으로 업데이트되는 스토리들

## 1단계 문제 이해 및 설계 범위 확정
 * 모바일, 웹 둘다 지원
 * 새로운 피드 올리고, 친구들의 피드 볼 수 있어야 한다.
 * 최대 친구 수 5000
 * 매일 천만명 방문
 * 이미지나 비디오 포함 가능

## 2단계 개략적 설계안 제시 및 동의 구하기
2가지 부분을 설계 나눌 수 있다.
1) 피드 발생 : 사용자가 스토리를 포스팅하면 저장하고 친구의 뉴스 피드에 전송해야 한다.
2) 뉴스 피드 생성 : 모든 친구들의 포스팅을 시간 흐름 역순으로 모아 만든다.

### 피드 발생
 * 웹서버 : http 요청을 내부 서비스로 중꼐하는 역할
![image](https://github.com/jaehleeee/study-docs/assets/48814463/57edee16-40fa-410f-8f43-e5b3469ef24d)


### 뉴스 피드 생성
 * 웹서버 : 트래픽을 뉴스 피드 서비스로 보낸다.
![image](https://github.com/jaehleeee/study-docs/assets/48814463/7d31f09a-ab8e-4f78-888d-3dc2b4c41e8e)


## 3단계 상세 설계
### 웹서버
 * 클라이언트와 통신할 뿐 만 아니라 인증이나 처리율 제한 등의 기능도 수행
 * 올바른 인증 토큰을 Authorization 헤더에 넣어야 한다.
 * 또한 특정 기간 동안 한 사용자가 올릴 수 있는 포스팅 수 제한

### 포스팅 전송 서비스
 * 어떤 사용자의 신규 발행 포스팅을 그 사용자와 친구인 모든 사용자에게 전달
 * 쓰기 시점에 전달하는 모델과 읽기 시점에 전달하는 모델이 있다.

### 쓰기 시점 push 포스팅 전송
 * 장점
   * 뉴스피드 실시간 갱신
   * 뉴스피드 읽는 시간이 짧다.
 * 단점
   * 친구가 많으면 친구 목록을 가져오고 각 사용자의 뉴스 피드를 갱신하는데 많은 시간 소요 (핫 키 문제)
   * 서비스를 자주 사용하지 않는 이용자의 피드까지 갱신해야하므로 낭비

### 읽기 시점 pull 포스팅 전송
 * 쓰기의 반대

### 채택한 설계안
 * 장점은 취하고 단점은 버리는 전략
 * 대부분의 사용자는 푸시 모델 사용
 * 친구가 많은 사용자는 팔로어로 하여금 해당 사용자의 포스팅을 필요로 할때 가져가도록 풀 모델 사용
 * 안정 해시를 통해 요청과 데이터 분산하여 핫키 문제 최소화

### 피드 발행 설계안 설명
 * 그래프 디비에서 친구 id 목록 가져오기
 * 사용자 정보 캐시에서 친구 정보 가져오기
 * 친구 목록과 새 포스팅 id를 메시지 큐에 넣는다.
 * 팬아웃 작업 서버가 메시지 ㅠ에서 데이터를 꺼내서 뉴스 피드 데이터를 뉴스 피드 캐시에 넣는다.
 * 뉴스 피드 캐시는 <포스팅 id, 사용자 id> 순서쌍을 보관하는 매핑 테이블
![image](https://github.com/jaehleeee/study-docs/assets/48814463/498bbbda-c0c2-45b6-a148-d79f60db2c53)

### 피드 읽기 상세 설계
 * 요청이 들어오면 로드밸런서와 웹서버를 통해 뉴스 피드 서비스 호출
 * 뉴스피드 서비스는 뉴스 피드 캐시에서 포스팅 id 목록 가져온다.
 * 가져온 포스팅 id를 통해 사용자 캐시와 포스팅 캐시에서 완전한 뉴스 피드 만든다.

![image](https://github.com/jaehleeee/study-docs/assets/48814463/9241ea7d-1235-4ffd-ad3b-83bd96a86213)

## 4단계 마무리
### 추가로 얘기해볼 내용
 * 웹 계층 무상태 운영
 * 여러 데이터 센저 지원
 * 메시지 큐를 사용하여 컴포넌트 사이 결합도 낮추기
 * 핵심 메트릭에 대한 모니터링.


