# 11장 결제 시스템
결제시스템이란? 금전적 가치의 이전을 통해 금융 거래를 정산하는 데 사용되는 모든 시스템

# 1단계: 문제 이해 및 설계 범위 확정
## 기능 요구사항
 * 대금 수신 : 판매자를 대신하여 고객으로부터 대금을 수령
 * 대금 정산 : 전세계의 판매자에게 제품 판매 대금을 송금

## 비기능 요구사항
 * 신뢰성 및 내결함성
    * 결제 실패 신중하게
 * 내부 서비스와 외부 서비스 간의 조정 프로세스 : 시스템 간의 결제 정보가 일치하는지 비동기적으로 확인   

## 개략적 규모 추정
 * 하루에 100만 트랜잭션 -> 초당 10건의 트랜잭션
 * 대역폭 대신 정확한 처리에 초점을 맞추저.

# 2단계: 개략적 설계안 제시 및 동의 구하기
 * 아마존을 예로 들면, 구매자가 주문하면 아마존 은행 계좌로 돈이 들어오는데, 이 돈 소유권은 아마존에 전부 있지 않다.
 * 아마존은 수수료만 받고 자금 관리자 역할만 수행
 * 제품 배송이 완료되면 판매 대금에서 수수료를 제외한 금액을 판매자의 계좌로 지급. 

## 대금 수신 흐름
![image](https://github.com/user-attachments/assets/f7ae0cee-0382-41eb-8996-d23e0b86d296)

### 구성요소
 * 결제 서비스
    * 사용자로부터 결제 이벤트를 수락하고 결제 프로세스 조율
    * 여러 결제 위험을 점검하고 통과한 결제만 처리한다.
    * 이러한 서비스는 매우 복잡하므로 전문화되어 있는 제3자 제공업체를 이용한다.
 * 원장
   * 결제 트랜잭션에 대한 금융 기록
   * 전자상거래 총 수익을 계산하거나 향후 수익 에측, 결제 후 분석 에서 매우 중요한 역할
 * 지갑
   * 판매자의 계정 잔액을 기록
   * 특정 사용자가 결제한 총 금액을 기록     

## 데이터 모델
### 결제 서비스 api : 결제 이벤트 실행
 * payment_order_id 는 전역적으로 고유하다. PSP 에서 중복 제거용 멱등키로 사용한다.
 * amount 가 double이 아닌 String 임에 유의
    * 직렬화, 역직렬화에 사용하는 숫자 정밀도가 달라, 의도치 않은 반올림 오류 유발할 수 있기 때문 
![image](https://github.com/user-attachments/assets/2cfea62e-5fa3-41cb-83a4-f67252722bb3)

## 결제 서비스 데이터 모델
 * 결제 시스템용 저장소 솔루션 선택시 고려 사항
   * 안정성 검증 (다른 대형 금융 회사에서 긍정적 피드백 여부)
   * 모니터링 및 데이터 탐사 도구가 풍부하게 지원 되는가
   * DBA 채용 시장이 성국한가
 * payment_order_status 에는 NOT_STARTED, EXECUTING, SUCCESS, FAILED 등이 있다. 
![image](https://github.com/user-attachments/assets/f3cc10db-be4f-4973-872a-3cf5253e0b66)

## 복식부기 원장 시스템
 * 원장 시스템에는 복식부기 라는 아주 중요 설계 원칙이 있다.
 * 모든 결제 거래를 2개의 별도 원장 계좌에 같은 금액을 기록하고, 하나는차감을 하나는 입금한다.
 * 그렇게 해서 모든 합계는 0 이어야 한다.

## 외부 결제 페이지
 * 대부분의 기업은 신용 카드 정보를 내부에 저장하지 않는다.
 * 내부에 저장하려면 복잡한 금융 규정을 준수해야 하기 때문.
 * 따라서, 이를 전문으로 하는 PSP 신용카드 페이지를 사용한다.

# 3단계: 상세 설계
## PSP 연동
 * 대부분의 회사는 psp 의 api를 활용하거나, psp 외부 결제 페이지를 사용한다.
### 외부 결제 페이지 이용 흐름
![image](https://github.com/user-attachments/assets/3fa4aefc-4fea-4175-a53e-f3e040a88f95)


## 조정 (reconciliation)
 * 시스템 성능을 높이기 위해 비동기 통신을 자주 사용하는데, 비동기 통신에도 정확성을 보장하려면 '조정' 과정이 필요하다
 * 조정은 관련 서비스 간의 상태를 주기적으로 비교하여 일치하는지 확인 하는 것
 * 매일 밤 PSP나 은행은 고객에게 정산 파일을 보낸다. 이를 조정 시스템이 확인하여 원장 시스템과 비교한다.
 * 조정 중 발견된 차이는 재무팀에 의뢰하여 수동으로 고친다.
   * 케이스별로 자동 해결 하거나, 재무팀 수동 수정하거나, 재무팀 특별 작업 대기열에 넣고 조사한다.

![image](https://github.com/user-attachments/assets/869f24fa-4ec1-419a-a94b-22c4bacc6448)


## 결제 지연 처리
### 결제 지연되는 몇가지 사례
 * PSP 가 해당 결제 요청 위험성이 높아 추가 검토 요구하는 경우
 * 신용 카드사가 구매확인 용도로 카드 소유자의 추가 정보를 요청하는 경우
### 처리 방안
 * 결제 대기 상태임을 클라이언트에 알린다. 관련 페이지도 제공한다.
 * P2P는 우리 회사를 대신하여 대기 상황을 추적하고 상태가 바뀌면 웹훅을 통해 결제 서비스에 알린다.

## 내부 서비스 간 통신
 * 동기식 통신과 비동기식 통신이 있다.
### 동기식 통신의 단점
 * 성능 저하
 * 장애 격리 관란 (장애 발생시 클라이언트는 더 이상 응답 받지 못한다)
 * 높은 결합도
 * 낮은 확장성

-> 비즈니스 로직이 복잡하고 타사 서비스 의존성이 높은 대규모 결제 시스템에는 비동기 통신이 더 나은 선택이다.

## 결제 실패 처리
 * 안정성 및 결함 내성은 결제 시스템의 핵심 요구사항이다.
### 결제 상태 추적
 * 결제 상태를 정확하게 유지해야 한다.
 * 실패가 발생할 때마다 현재 상태를 파악하고 재시도 또는 환불이 필요한지 여부를 결정한다.
### 재시도 큐 및 실패 메시지 큐
 * 재시도 큐 : 일시적 오류 같은 재시도 가능 오류는 재시도 큐에서 처리
 * 실패 메시지 큐 : 반복 처리에 실패한 메시지는 실패 메시지 큐로 보내서, 메시지를 디버깅하고 격리하여 성공적으로 처리되지 않은 이유를 추후 검사한다.


![image](https://github.com/user-attachments/assets/a794bbc7-1d32-4d77-a47c-bb4600921df3)


## 정확히 한번 전달
 * 이중 청구 되지 않도록 설계하는 것도 매우 중요하다.
 * 최소 한번 실행해야 하며, 최대 한번 실행해야 한다.
 * 재시도를 통해 최소 한번 실행을 보증하고, 멱등성 검사를 통해 최대 한번 실행을 보증해야 한다.
    * 재시도 전략은 상황에 따라 다르지만, 네트워크 문제가 단시간 내에 해결될 것 같지 않다면 지수적 백오프를 사용해야 한다.
### 재시도시 발생할 수 있는 잠재적 문제 : 이중 결제
시나리오1 : 클라이언트가 결제 버튼을 두 번 클릭
시나리오2 : 네트워크 이슈로 PSP 성공 응답이 전달되지 못한 경우
 * 시나리오1 해결
    * 요청에 포함된 멱등 키를 활용
 * 시나리오2 해결
    * 결제 시스템에서 비중복 난수를 전송하면, P2P 해당 난수에 대응하는 토큰을 반환한다. 이 값들을 통해 유일한 결제 임을 증명한다.
## 일관성
 * 내부 서비스와 외부 서비스 간의 데이터 일관성 유지를 위해 멱등성과 조정 프로세스를 잘 활용해야 한다.
 * 데이터 다중화로 인한 복제 지연이 발생할 수 있는데, 아래 2가지 방법으로 해결 가능
   * 주 DB 에서만 읽기, 쓰기 처리.
     * 규모 확장성 떨어진다
   * 모든 사본 항상 동기화
     * 팩서스, 래프트 같은 합의 알고리즘을 사용하거나 합의 기반 분산 데이터베이스를 사용한다. 

## 보안
![image](https://github.com/user-attachments/assets/dfd943aa-a140-499f-9277-6a2d3532bac0)

## 4단계: 마무리
### 추가로 살펴볼만한 주제
* 모니터링
* 경보
* 디버깅 도구
* 환율
* 지역
* 현금 결제
* 구글,애플 페이 연동

## 복습 겸 다시 짚어봐야할 부분
 * 대금 수신과 대금 정산 흐름
 * 실패 처리
 * 조정 로직
 * 일관성 유지 전략

