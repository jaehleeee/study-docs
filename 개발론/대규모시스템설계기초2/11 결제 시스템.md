# 11장 결제 시스템
결제시스템이란? 금전적 가치의 이전을 통해 금융 거래를 정산하는 데 사용되는 모든 시스템

# 1단계: 문제 이해 및 설계 범위 확정
## 기능 요구사항
 * 대금 수신 : 판매자를 대신하여 고객으로부터 대금을 수령
 * 대금 정산 : 전세계의 판매자에게 제품 판매 대금을 송금

## 비기능 요구사항
 * 신뢰성 및 내결함성
    * 결제 실패 신중하게
 * 내부 서비스와 외부 서비스 간의 조정 프로세스 : 시스템 간의 결제 정보가 일치하는지 비동기적으로 확인   

## 개략적 규모 추정
 * 하루에 100만 트랜잭션 -> 초당 10건의 트랜잭션
 * 대역폭 대신 정확한 처리에 초점을 맞추저.

# 2단계: 개략적 설계안 제시 및 동의 구하기
 * 아마존을 예로 들면, 구매자가 주문하면 아마존 은행 계좌로 돈이 들어오는데, 이 돈 소유권은 아마존에 전부 있지 않다.
 * 아마존은 수수료만 받고 자금 관리자 역할만 수행
 * 제품 배송이 완료되면 판매 대금에서 수수료를 제외한 금액을 판매자의 계좌로 지급. 

## 대금 수신 흐름
![image](https://github.com/user-attachments/assets/f7ae0cee-0382-41eb-8996-d23e0b86d296)

### 구성요소
 * 결제 서비스
    * 사용자로부터 결제 이벤트를 수락하고 결제 프로세스 조율
    * 여러 결제 위험을 점검하고 통과한 결제만 처리한다.
    * 이러한 서비스는 매우 복잡하므로 전문화되어 있는 제3자 제공업체를 이용한다.
 * 원장
   * 결제 트랜잭션에 대한 금융 기록
   * 전자상거래 총 수익을 계산하거나 향후 수익 에측, 결제 후 분석 에서 매우 중요한 역할
 * 지갑
   * 판매자의 계정 잔액을 기록
   * 특정 사용자가 결제한 총 금액을 기록     

## 데이터 모델
### 결제 서비스 api : 결제 이벤트 실행
 * payment_order_id 는 전역적으로 고유하다. PSP 에서 중복 제거용 멱등키로 사용한다.
 * amount 가 double이 아닌 String 임에 유의
    * 직렬화, 역직렬화에 사용하는 숫자 정밀도가 달라, 의도치 않은 반올림 오류 유발할 수 있기 때문 
![image](https://github.com/user-attachments/assets/2cfea62e-5fa3-41cb-83a4-f67252722bb3)

## 결제 서비스 데이터 모델
 * 결제 시스템용 저장소 솔루션 선택시 고려 사항
   * 안정성 검증 (다른 대형 금융 회사에서 긍정적 피드백 여부)
   * 모니터링 및 데이터 탐사 도구가 풍부하게 지원 되는가
   * DBA 채용 시장이 성국한가
 * payment_order_status 에는 NOT_STARTED, EXECUTING, SUCCESS, FAILED 등이 있다. 
![image](https://github.com/user-attachments/assets/f3cc10db-be4f-4973-872a-3cf5253e0b66)

## 복식부기 원장 시스템
 * 원장 시스템에는 복식부기 라는 아주 중요 설계 원칙이 있다.
 * 모든 결제 거래를 2개의 별도 원장 계좌에 같은 금액을 기록하고, 하나는차감을 하나는 입금한다.
 * 그렇게 해서 모든 합계는 0 이어야 한다.

## 외부 결제 페이지
 * 대부분의 기업은 신용 카드 정보를 내부에 저장하지 않는다.
 * 내부에 저장하려면 복잡한 금융 규정을 준수해야 하기 때문.
 * 따라서, 이를 전문으로 하는 PSP 신용카드 페이지를 사용한다.

# 3단계: 상세 설계
## PSP 연동
 * ㅇㅇ

## 조정 (reconciliation)
 * ㅇㅇ

## 결제 지연 처리
 * ㅇㅇ

## 내부 서비스 간 통신
 * ㅇㅇ

## 결제 실패 처리
 * ㅇㅇ

## 정확히 한번 전달
 * ㅇㅇ

## 일관성
 * ㅇㅇ

## 보안
 * ㅇㅇ






## 4단계: 마무리



