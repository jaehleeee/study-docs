# 1장 근접성 서비스
 * 근접성 서비스는 음식점, 호텔, 극장, 박물관 등 현재 위치에서 가장 가까운 시설을 찾는 데 이용되며,
 * 옐프 앱의 경우 주변에 있는 좋은 식당 검색,
 * 구글 맵의 경우에는 가까운 k개 주유소 검색 등의 기능 구현에 이용된다.

## 1단계: 문제 이해 및 설계 범위 확정
### 기능 요구사항
 * 사용자 위치 정보(위도, 경도)와 검색 반경 정보에 매치되는 사업장 목록 반환
 * 사업자 정보 추가,삭제,갱신 (실시간 반영은 불필요)
 * 고객은 사업장 상세 정보 살필 수 있어야 한다.

### 비기능 요구사항
 * latency
 * 데이터 보호
 * 고가용성 및 규모 확장성

### 개략적 규모 추정
 * DAU : 1억명 (100M)
 * 등록된 사업장 수 : 2억 (200)
#### QPS
 * 1일은 86400초, 계산 쉽게 100,000으로 앞으로 올림하여 쓰는 것으로.
 * 한 사용자가 하루에 5번 검색 가정하면
 * QPS : 1억 * 5 / 100,000 = 5,000

## 2단계: 개략적 설계안 제시 및 동의 구하기
### API 설계
 * 사업장 목록 조회
 * 사업장 등록/수정/삭제/상세조회

### 데이터 모델
 * 읽기 연산이 압도적으로 많은 시스템에서는 MySQL 같은 관계형 데이터베이스가 적절 (왜?)

### 개략적 설계
<img src="https://github.com/jaehleeee/study-docs/assets/48814463/b51b5ec3-937a-4df6-8939-13b36574f28c" width="500"/>

#### 시스템의 핵심 : 위치 기반 서비스 LBS (Location-based service)
 * 주어진 위치와 반경 정보를 이용해 주변 사업장을 검색한다.
 * 쓰기 요청이 없는 읽기 요청만 빈번하게 발생하는 서비스
 * QPS가 높다. 특정 시간대 인구 밀집 지역일수록 그 경향이 심하다.
 * 무상태 서비스 이므로 수평적 규모 확장이 쉽다
### 사업장 서비스
 * 사업장 소유주가 사업장 정보를 생성, 갱신, 삭제 한다.
 * 쓰기 요청이 많고, qps 낮다.
 * 고객의 사업장 정보 조회는 특정 시간대 qps가 높다.
### LBS와 사업장 서비스의 규모 확장성
 * 둘다 무상태 서비스이므로, 점심 시간 등 특정 시간대 트래픽 집중될때 서버를 유연하게 가져가자.

### 주변 사업장 검색 알고리즘
 * 많은 회사들은 레디스 지오해시 or PostGIS 확장을 설치한 포스트그레스 데이터베이스를 활용한다.
 * 몇가지 방안을 살펴보자.

#### 방안1: 2차원 검색
 * 직관적이고 단순하게, 주어진 반영 내 놓은 사업장을 검색하는 방법이다.
 * mysql 조회 예시 - WHERE (latitude between 내위치-radius AND 내위치+radius) AND (longitude between 내위치-radius AND 내위치+radius)
   * 이 질의는 테이블을 전부 읽어야하므로 비효율적이다.
   * index 를 만들어도 위도와 경도 2차원에서의 데이터 양이 많아 효율적일수가 없다.
   * -> 따라서 검색 속도를 개선하려면 한 차원의 검색 속도만 개선하도록 해야 한다.
 * 먼저 색인을 만드는 방법부터 알아보면, 해시와 트리가 있다. 

#### 방안2: 균등 격자
 * 지도를 단순한 격자 또는 구획으로 나누는 단순한 접근법이다.
 * 단점은 사업장 분포가 구획마다 균등하지 않다는 것이다.
 * 인구 밀집 지역은 작은 격자를, 아니면 큰 격자를 쓰는 방법이 있다.
 * 추가 단점은 주어진 격자의 인접 격차를 찾기가 까다로울 수 있다는 점이 있다.

#### 방안3: 지오해시
 * 2차원의 위도 경도 데이터를 1차원의 문자열로 변환한다.
 * 비트를 하나씩 늘려가면서 재귀적으로 세계를 더 작은 격자로 분할해간다.
 * 이때 격자를 나누는 과정에서 공통 격자에 속하면 속할수록 해시 코드도 매우 비슷한 값을 가진다.
 * 지오해시는 총 12단계의 정밀도를 가진다. 우리가 사용한 정밀도는 4~6 사이. 6보다 길어지면 한 격자가 너무 작아진다.
 * 단점은 격자 가장자리 이슈가 있다.
   1. 꽤 가까운 두 위치가 아예 다른 격자 해시코드를 가질 수도 있다.
   2. 매우 가까운 두 위치가 서로 다른 격자에 놓일수도 있다.
* 흔한 해결책은 인접 격자를 모두 조회하는 것, 표시할 사업장이 충분하지 않은 경우도 마찬가지

<img src="https://github.com/jaehleeee/study-docs/assets/48814463/68655760-28f3-4875-bcfe-95965ba1adb9" width="500"/>

#### 방안4: 쿼드트리
 * 격자의 내용이 특정 기준을 만족할때까지 2차원 공간을 재귀적으로 사분면 분할하는데 흔히 사용되는 자료구조
 * 예를들면 격자에 담긴 사업장 수가 100개 이하가 될때까지 분할할 수 있다.
 * 데이터베이스가 아니라 메모리 안에 놓이는 자료구조이므로, 각 LBS 서버에 존재한다. (서버가 시작하는 시점에 구축)
 * 말단 노드에 수록되는 데이터 : 832바이트
    * 격자 식별 8바이트씩 4꼭지이므로 32바이트 : 32 바이트
    * 격자 내부 사업장 100개 : 8 * 100 : 800 바이트
 * 내부 노드에 수록되는 데이터 : 64 바이트
    * 격자 식별 32바이트
    * 하위 노드 4개를 가리킬 포인터 32바이트

 * 총 메모리 요구량  =~ 1.71GB
    * 말단 노드 당 100개의 사업장 가지므로, 말단 노드의 수는 200m / 100 = 2m (2백만)
    * 내부 노드의 수는 2백만 * (1/3) = 0.67m
 * 정체 쿼드트리 구축 소요시간은 몇 분 정ㄷ로 소요
 * 운영시 고려사항
   * 서버 시작시 트리 구축을 위한 시간이 길어질 수 있다.
   * 그렇기 때문에 블루그린 배포 추천.
   * 사업장의 추가/삭제되었을 때 쿼드트리 갱신 문제
     * 점진적으로 몇개씩만 갱신 

<img src="https://github.com/jaehleeee/study-docs/assets/48814463/3c5250f1-3bb1-41ce-86fb-6fe71e4dd1cf" width="500"/>


#### 방안5: 구글 S2
 * 구글의 기하 라이브머리
 * 메모리 기반

### 지오해시 vs 쿼드트리
 * 지오해시
   * 구현이 쉽다.
   * 지정 반경 내 사업자 검색 지원
   * 색인 갱신이 쉽다.
 * 쿼드트리
   * 구현이 살짝 더 까다롭다.
   * k 번째로 가까운 사업장 목록 구할 수 있다. (검색 반경에 관계없이)
   * 인구 밀도에 따라 격자 크기 동적 조정 가능
   * 색인 갱신이 까다롭다.
  
## 3단계: 상세 설계
 * 데이터베이스 규모 확장성
 * 캐시
 * 지역 및 가용성 구역
 * 시간대 또는 사업장 유형에 따른 검색
 * 최종 아텍처 다이어그램

### 데이터베이스 규모 확장성
 * 사업장 테이블 : 샤딩으로 해결
 * 지리정보 색인 테이블 (지오해시)
   * 같은 지오해시에 속한 사업장 ID 각각을 별도의 열로 저장
   * 사업장 ID와 지오해시클 합친 복합 키 사용
 * 지리정보 색인 구모 확장
   * 지오해시 색인 양이 많진 않다.
   * 다만 읽기 연산 빈도가 높다면, 관계형 데이터베이스의 경우 읽기 연산을 지원할 사본 데이터베이스 서버를 늘리는 것이 좋다.

 ### 캐시
 * 캐시 계층 도입에는 항상 먼저 던져야하는 질문이 있다. 정말 필요한가?
 * 처리 부하가 읽기 중심이고 데이터 양이 크지 않으므로 한대 서버에 수용가능하다
 * 읽기 성능이 병목이라면 사본 데이터베이스를 증설하자.

### 캐시키
 * 지오해시나 쿼드트리를 활용

### 지역 및 가용성 구역
 * 위치 기반 서비스는 여러 지역과 가용성 구역에 설치
 * 그 이유는,
   * 사용자와 시스템 사이 물리적 거리를 최소한으로 줄일 수 있다.
   * 트래픽 인구에 따라 고르게 분산하는 유연성
   * 그 지역에 사생활 보호법에 맞는 운영

### 최종 설계도
#### 주변 사업장 검색 (ex: 옐프에서 주변 반경 500미터 내 모든 식당 검색)
1. 클라이언트 앱은 사용자의 위치를 LB로 전송
2. LB -> LBS 요청 전달
3. LBS는 검색 요건을 만족할 지오해시 길이 계산 (500미터면 6이다.)
4. LBS는 인접한 지오해시를 계산한 다음 목록에 추가한다. (list_of_geohashes = [...])
5. list_of_geohashes 내에 있는 각 지오해시에 대해 지오해시 레디스 서버를 호출하여 해당 지오해시들의 모든 사업장 id를 추출한다.
    * 각 지오해시별 연산을 병렬로 수행하면 빠르게 처리 가능
6. 반환된 사업장 id들을 가지고 사업장 정보를 레디스 서버를 조회하여 상세 정보 취득
7. 각 사업장과 사용자 간 거리를 계산하고 우선순위를 매긴 다음 클라이언트 앱으로 반환. 

<img src="https://github.com/jaehleeee/study-docs/assets/48814463/f1e33438-7491-46b2-a0a0-e1f5fa8b7195" width="500"/>

## 4단계: 마무리
정리
