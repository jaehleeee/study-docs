# 1장 근접성 서비스
 * 근접성 서비스는 음식점, 호텔, 극장, 박물관 등 현재 위치에서 가장 가까운 시설을 찾는 데 이용되며,
 * 옐프 앱의 경우 주변에 있는 좋은 식당 검색,
 * 구글 맵의 경우에는 가까운 k개 주유소 검색 등의 기능 구현에 이용된다.

## 1단계: 문제 이해 및 설계 범위 확정
### 기능 요구사항
 * 사용자 위치 정보(위도, 경도)와 검색 반경 정보에 매치되는 사업장 목록 반환
 * 사업자 정보 추가,삭제,갱신 (실시간 반영은 불필요)
 * 고객은 사업장 상세 정보 살필 수 있어야 한다.

### 비기능 요구사항
 * latency
 * 데이터 보호
 * 고가용성 및 규모 확장성

### 개략적 규모 추정
 * DAU : 1억명 (100M)
 * 등록된 사업장 수 : 2억 (200)
#### QPS
 * 1일은 86400초, 계산 쉽게 100,000으로 앞으로 올림하여 쓰는 것으로.
 * 한 사용자가 하루에 5번 검색 가정하면
 * QPS : 1억 * 5 / 100,000 = 5,000

## 2단계: 개략적 설계안 제시 및 동의 구하기
### API 설계
 * 사업장 목록 조회
 * 사업장 등록/수정/삭제/상세조회

### 데이터 모델
 * 읽기 연산이 압도적으로 많은 시스템에서는 MySQL 같은 관계형 데이터베이스가 적절 (왜?)

### 개략적 설계

![image](https://github.com/jaehleeee/study-docs/assets/48814463/b51b5ec3-937a-4df6-8939-13b36574f28c)

#### 시스템의 핵심 : 위치 기반 서비스 LBS (Location-based service)
 * 주어진 위치와 반경 정보를 이용해 주변 사업장을 검색한다.
 * 쓰기 요청이 없는 읽기 요청만 빈번하게 발생하는 서비스
 * QPS가 높다. 특정 시간대 인구 밀집 지역일수록 그 경향이 심하다.
 * 무상태 서비스 이므로 수평적 규모 확장이 쉽다
### 사업장 서비스
 * 사업장 소유주가 사업장 정보를 생성, 갱신, 삭제 한다.
 * 쓰기 요청이 많고, qps 낮다.
 * 고객의 사업장 정보 조회는 특정 시간대 qps가 높다.
### LBS와 사업장 서비스의 규모 확장성
 * 둘다 무상태 서비스이므로, 점심 시간 등 특정 시간대 트래픽 집중될때 서버를 유연하게 가져가자.

### 주변 사업장 검색 알고리즘
 * 많은 회사들은 레디스 지오해시 or PostGIS 확장을 설치한 포스트그레스 데이터베이스를 활용한다.
 * 몇가지 방안을 살펴보자.

#### 방안1: 2차원 검색
 * 직관적이고 단순하게, 주어진 반영 내 놓은 사업장을 검색하는 방법이다.
 * mysql 조회 예시 - WHERE (latitude between 내위치-radius AND 내위치+radius) AND (longitude between 내위치-radius AND 내위치+radius)
   * 이 질의는 테이블을 전부 읽어야하므로 비효율적이다.
   * index 를 만들어도 위도와 경도 2차원에서의 데이터 양이 많아 효율적일수가 없다.
   * -> 따라서 검색 속도를 개선하려면 한 차원의 검색 속도만 개선하도록 해야 한다.
 * 먼저 색인을 만드는 방법부터 알아보면, 해시와 트리가 있다. 

#### 방안2: 균등 격자
 * 지도를 단순한 격자 또는 구획으로 나누는 단순한 접근법이다.
 * 단점은 사업장 분포가 구획마다 균등하지 않다는 것이다.
 * 인구 밀집 지역은 작은 격자를, 아니면 큰 격자를 쓰는 방법이 있다.
 * 추가 단점은 주어진 격자의 인접 격차를 찾기가 까다로울 수 있다는 점이 있다.

#### 방안3: 지오해시
 * 2차원의 위도 경도 데이터를 1차원의 문자열로 변환한다.
 * 비트를 하나씩 늘려가면서 재귀적으로 세계를 더 작은 격자로 분할해간다.
 * 이때 격자를 나누는 과정에서 공통 격자에 속하면 속할수록 해시 코드도 매우 비슷한 값을 가진다.
 * 지오해시는 총 12단계의 정밀도를 가진다. 우리가 사용한 정밀도는 4~6 사이. 6보다 길어지면 한 격자가 너무 작아진다.
 * 단점은 격자 가장자리 이슈가 있다.
   1. 꽤 가까운 두 위치가 아예 다른 격자 해시코드를 가질 수도 있다.
   2. 매우 가까운 두 위치가 서로 다른 격자에 놓일수도 있다.
* 흔한 해결책은 인접 격자를 모두 조회하는 것, 표시할 사업장이 충분하지 않은 경우도 마찬가지

![image](https://github.com/jaehleeee/study-docs/assets/48814463/68655760-28f3-4875-bcfe-95965ba1adb9)

#### 방안4: 쿼드트리

![image](https://github.com/jaehleeee/study-docs/assets/48814463/3c5250f1-3bb1-41ce-86fb-6fe71e4dd1cf)







