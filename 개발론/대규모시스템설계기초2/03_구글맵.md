# 3장 구글맵
 * 구글 맵은 위성 이미지, 거리 뷰, 실시간 교통 상황, 경로 계획 등 다양한 서비스를 제공하고 있다.
 * 2021년 3월 현대 DAU 10억 명이다.

## 1단계: 문제 이해 및 설계 범위 확정
### 기능 요구사항
 * 사용자 위치 갱신
 * 경로 안내 서비스 (ETA 서비스 포함)
 * 지도 표시

### 비기능 요구사항
 * 정확도 : 잘못된 경로 안내하면 안된다.
 * 부드러운 경로 표시 : 화면에 부드럽게 표시되고 갱신되어야
 * 데이터 및 배터리 사용량 : 클라이언트는 가능한 최소 데이터와 배터리 사용해야 한다.
 * 일반적인 가용성 및 규모 확장성 요구사항 만족

### 설계에 필요한 기본 개념 및 용어
#### 지도 101
 * 측위 시스템
 * 3차원 위치의 2차원 변환 : 3차원 구 위의 위치를 2차원 평면에 대응시키는 절차
 * 지오코딩 : 주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스, 주소 -> 위도 & 경도
 * 지오해싱 : 지도 위 특정 영역을 영문자와 숫자로 구성된 문자열에 대응 시키는 인코딩 체계
 * 지도표시 : 타일 개념을 활용하여 지도를 작은 타일로 쪼개어 표시
 * 경로 안내 알고리즘을 위한 도로 데이터 처리 : 모든 경로 탐색 알고리즘은 교차로를 노드, 도로는 선으로 표현
 * 계층적 경로 안내 타일 : 효과적 경로 안내를 위해서는 필요한 수준의 구체성을 갖춘 도로 데이터 필요
    * 구체성 정도를 상,중,하 로 구분하여 3 가지 종류의 경로 안내 타일을 준비한다. 각 타일에는 다른 정밀도 타일로 연결된는 선이 있을 수 있다.  

### 개략적 규모 추정
#### 저장소 사용량
1. 세계지도
  * 확대 수준별로 지도 타일을 한 벌씩 두어야 한다.
  * 21번 확대 기준.
  * 최대 확대 수준을 대상으로 4.4조 개 타일 필요
  * 1개 타일 100KB 로 가정하면 440PB 저장 공간 필요
  *  지구 표면 90%는 인간이 살지 않으므로 보수적으로 50PB 필요
  * 최소 확대 수준~최대확대 수준을 모두 커버하려면 등비수열?로 67PB 필요인데 대략적으로 100PB로 두자.
2. 서버 대역폭 
 * 서버가 처리하는 요청은 크게 2가지
   * 경로 안내 요청 (클라이언트가 경로 안내 세션을 시작할때)
   * 위치 갱신 요청 (클라이언트가 경로 안래르 진행하는 동안 변경된 사용자 위치를 전송하는 메세지)
 * 대역폭 추정
    * DAU 10억
    * 각 사용자는 주당 35분 사용
    * 주당 350억 분, 하루 50억분 사용
    * GPS 좌표를 매초 전송하려면 300만 QPS
    * 하지만 이를 모두 매초마다 보낼 필요없고, 모아놨다가 30초 (예를들면) 마다 써도 된다.
    * 15초로 가정하면 QPS는 20만 으로 줄어든다.
    * 최대 QPS 는 평균치의 5배로 가정하겠다 (왜?) 그럼 위치 정보 갱신 요청은 최대 QPS는 100백만이다.


## 2단계: 개략적 설계안 제시 및 동의 구하기
![image](https://github.com/jaehleeee/study-docs/assets/48814463/fa26fbe0-b634-4289-be1a-8dc36ff07b1d)

### 3가지 기능
 * 위치 서비스
 * 경로 안내 서비스
 * 지도 표시

### 위치 서비스
 * 사용자의 위치를 기록하는 역할
 * t초 마다 자기 위치를 전송
 * 해당 정보는 실시간 교통 상황 모니터링이나 새 도로나 폐쇄된 도로 탐지, 행동 양태 분석 등에 사용될 수 있다.
 * 클라이언트가 보내는 정보가 거의 실시간에 가까우므로 ETA를 좀 더 정확하게 산출할 수 있고 교통상황에 따라 다른 경로 안내 가능.
 * 높은 쓰기 요청에 최적화되어 있고 규모 확장에 용이한 카산드라 데이터베이스가 적합
 * 통신은 HTTP keep-alive 옵션이 좋아보임.

### 경로 안내 서비스
 * 최단 경로일 필요는 없지만, 정확해야 한다.
 * 출발지와 목적지 인자가 전달되는 api 요청일 것이다.
 * 경로 재탐색이나 교통 탐색 상황 변경 등의 고려사항은 상세 설계에서 적응형 ETA 를 통해 해결 예정

### 지도 표시
 * 클라이언트의 위치 및 확대 수준에 따라 필요한 타일을 서버에서 가져와야 한다.
 * 그렇다면 언제 가져오는가?
    * 사용자가 확대 또는 이동하며 주변을 탐색할때
    * 사용자가 인접 타일로 이동할때
 * 지도 타일 데이터를 효과적으로 가져오는 방법
   * 선택지1: 현재 클라이언트가 보는 지도 확대 수준에 근거하여 즉석에서 타일으 만드는 방안
     * 모든 지도 타일을 동적으로 만들어야 하며 서버 부하, 캐시 활용도 낮다.
   * 선택지2: 확대 수준별로 미리 만들어둔 지도 타일을 전달
     * 미리 만들어둔 정적 이미지를 CDN 을 통해 제공
     * 사용자에게 가장 가까운 pop에서 파일을 서비스 한다.
       
#### 데이터 사용량
* 한 사용자가 30km/h 속도 이동중이며 한 이미지가 200m x 200m 영역 표현하도록 확대하여 지도 표시
* 이미지 하나의 평균 크기는 100KB
* 1km x 1km 표현하려면 이미지 25장 필요, 2.5MB
* 시속 30km 이므로 시간당 7.5MB 소진하며 이는 분당 1.25MB

#### CDN을 통해 서비스되는 트래픽 규모
 * 매일 50억 분 가량 겅료 안내 처리한다.
 * 50억 * 1.25MB = 6.25PB/일
 * 초당 전송해야 하는 데이터양은 62,500 MB (6.25PB / 10^5)
 * 전세계 팝이 200개라고 가정하면 POP 당 수백 MB만 처리하면 된다.

#### 사용자가 이동하거나 확대 수준을 변경하면 지도 타일은 어떻게 가져오는가
 1. 지도 타일 서비스 호출
 2. 로드밸런소로 요청이 들어오면 지도 타일 서비스로 전달
 3. 지도 타일 서비스는 클라이언트 위치와 확대 수준을 입력받아 9개의 타일url을 계산하여 클라이언트로 전달
 4. 클라이언트는 이를 CDN을 통해 다운로드

## 3단계: 상세 설계





## 4단계: 마무리
 * 이번 장 핵심 기능 : 위치 갱신, ETA, 경로 계획, 지도 표시
 * 시스템 확장에 관심 있다면? 기업 고객 대상으로 중간 공유지 설정 기능 제공도 고려 가능
